# 自定义服务API

除了使用系统预置的基础服务API外，您还可以根据业务需要，新建自定义服务API。本文介绍如何创建自定义服务API。

## 前提条件

已创建数据源相关的指标和数据集，具体信息，请参见[指标概述]()。

## 操作步骤

1.  登录[物联网平台控制台](http://iot.console.aliyun.com/)。

2.  在实例概览页面，找到对应的数据型实例，单击实例进入实例详情页面。

3.  在左侧导航栏，选择**数据分析** \> **数据服务**。

4.  在**API列表**，单击**自定义服务API**，然后单击**新建API**。

    ![新建API](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6478394161/p245813.gif)

5.  在**新建API**页面，完成**API基本信息**的配置，然后单击**下一步**。

    ![API基本信息](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0996025161/p245814.gif)

    |参数|描述|
    |--|--|
    |API名称|输入API名称。支持中文、英文字母、数字、下划线（\_）。长度不超过30个字符。|
    |API Path|输入API路径。作为API资源标识符，实例下具有唯一性。调用API时，请求参数中apiPath的值与之对应。以正斜线（/）开头，支持英文字母、数字、下划线（\_）、正斜线（/），长度不超过128个字符。例如：`pk/temperatureMax`。**说明：** API发布后，API Path不支持修改。 |
    |API标签|输入标签内容后，按回车键，生成标签。使用标签功能，为API自定义标识，以便灵活管理API。一个API最多可添加5个标签。 |
    |API描述|输入API的描述，说明API的功能等信息。|
    |返回类型|调用API后，返回数据的格式，固定为JSON。|

6.  在**配置参数并测试**页面，完成以下配置。

    |类别|参数|说明|
    |--|--|--|
    |数据源|指标域|选择指标域。指标域是指标所属的对象，用于分类管理指标。更多信息，请参见[什么是指标]()。|
    |数据集|选择对应指标域的数据集。数据集是指定指标域下设备数据的集合。更多信息，请参见[数据集概述]()。|
    |配置参数|数据集|完成数据源配置后，自动显示所选的数据集。单击**预览数据**，可跳转至该数据集的详情页。|
    |数据范围|选择API的数据范围。    -   衍生指标：基于原始指标、原始定义、衍生定义，经过加和、平均等汇总计算方式得到的数据。
    -   衍生定义：以原始定义为基础，并应用到子实体上的原始定义指标的衍生。
更多信息，请参见[指标类型]()。 |
    |请求参数|单击**添加参数**，将所选数据集的指标，添加到API的请求参数。单个指标可配置成多个不同的请求参数。添加的参数需包括绑定字段、参数名、参数类型、操作符、必选、示例值、参数描述。

**说明：** 参数类型为数值型时，操作符不支持`LIKE`。 |
    |返回参数|单击**添加参数**，将所选数据集的指标，添加到API的返回参数。添加的参数需包括优先级、绑定字段、参数名、参数类型、用于排序、示例值、参数描述。

**说明：**

    -   用于排序是指对查询获取的数据根据该字段的值进行排序（升序或降序），排序后再返回查询结果。
    -   在返回参数里，一个指标仅能被配置成一个参数。 |
    |排序方式|选择参数的排列顺序。    -   升序（默认）：参数以升序排列。
    -   降序：参数以降序排列。 |
    |高级设置|开启返回结果分页|选择是否开启返回结果分页。    -   不开启：仅可查看100条以内的返回结果。
    -   开启：可分页查看所有返回结果。开启后，自动增加以下公共参数：
        -   pageNum：分页的页码。
        -   pageSize：每页显示结果的条数，最大值为100。 |
    |超时报错设置|调用API的请求超过8000毫秒时，返回超时报错。不支持修改该参数。|

    完成上述配置后，在**测试API**区域内，输入请求参数的测试值后，单击**开始测试**。

    您可在**返回示例**页签查看返回的示例数据，也可单击**请求详情**查看发起请求后的具体信息。

    ![测试API](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7478394161/p245823.gif)

7.  单击**发布**。

    **说明：**

    -   发布API前，需确保该API已通过测试。
    -   仅单击**保存**的API，显示状态为未上线。
    -   未完成配置的API，可单击对应的**编辑**，完成配置后发布上线。
    -   仅可删除未上线和已下线的API，删除后7天内可[提交工单](https://selfservice.console.aliyun.com/ticket/category/iot/today)，申请恢复。
    在**发布成功**页面，单击**再次新建**，可创建多个自定义API；单击**去列表查看**，可查看已创建的API。

    ![发布成功](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/7478394161/p245825.gif)


## 后续操作

创建好的自定义服务API可以调用来获取数据。具体操作，请参见[使用数据服务](/cn.zh-CN/数据服务/使用数据服务.md)。

